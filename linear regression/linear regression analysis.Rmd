---
title: "simple linear regression analysis"
output: html_document
---

```{r setup, include=FALSE}
library(brms)
library(rstanarm)
library(bayestestR)
library(BayesFactor)
library(cmdstanr)
library(emmeans)
library(parallel)
library(bridgesampling)
library(tidyverse)
library(extraDistr)
library(binom)
```

```{r}
#read in results 
tighter3_n100 <- bind_rows(results_3groups, .id = "id")

rm(tighter3_n20, tighter3_n50, tighter3_n30, tighter3_n100)
save(final_twogroups, file = "simulation_2group.rda")
save(final_threegroups, file = "simulation_3group.rda")
```

```{r}
tighttwogroups <- bind_rows(tighter2_n20, tighter2_n30, tighter2_n50, tighter2_n100)
tightthreegroups <- bind_rows(tighter3_n20, tighter3_n50, tighter3_n30, tighter3_n100)

final_twogroups <- bind_rows(twogroups, tighttwogroups)
final_threegroups <- bind_rows(threegroups, tightthreegroups)
```
#tests 
```{r}
alpha <- 0.05 #set threshold for significance 
#pvalues
final_twogroups <- final_twogroups %>% 
  mutate(wald_significance = if_else(pval < alpha, "sig", "nonsig"), 
         likelihood_sig = if_else(p_likelihood < alpha, "sig", "nonsig"), 
         likelihood_max_sig = if_else(p_likelihood_max < alpha, "sig", "nonsig")) #p<.05 --> rej null TRUE, do not rej FALSE

final_threegroups <- final_threegroups %>% 
  mutate(wald_significance = if_else(pval < alpha, "sig", "nonsig"), 
         likelihood_sig = if_else(p_likelihood < alpha, "sig", "nonsig"), 
         likelihood_max_sig = if_else(p_likelihood_max < alpha, "sig", "nonsig")) #p<.05 --> rej null TRUE, do not rej FALSE

#bayes factors 
final_twogroups <- final_twogroups %>% mutate(bf_prop = if_else(exp(bf) > 3, "null", "no"))
final_threegroups <- final_threegroups %>% mutate(bf_prop = if_else(exp(bf) > 3, "null", "no"))
exp(0.57763990)

#loo & waic 
final_twogroups <- final_twogroups %>% mutate(
  loo_results = if_else(abs(loo_diff) > abs(2*loo_se),"yes", "no"),
  waic_results = if_else(abs(waic_diff) > abs(2*waic_se), "yes", "no")
)

final_threegroups <- final_threegroups %>% mutate(
  loo_results = if_else(abs(loo_diff) > abs(2*loo_se),"yes", "no"),
  waic_results = if_else(abs(waic_diff) > abs(2*waic_se), "yes", "no")
)
```

#run from here for results 
```{r}
load("simulation_2group.rda")
load("simulation_3group.rda")
```

```{r}
iter = 1000
wald_2group <- final_twogroups %>% 
  group_by(n, type) %>% 
  count(wald_significance) %>% 
  pivot_wider(names_from = "wald_significance", values_from = "nn") %>% 
  mutate(rate_typeIerr = sig/iter)

wald_3group <- final_threegroups %>% 
  group_by(n, type) %>% 
  count(wald_significance)%>% 
  pivot_wider(names_from = "wald_significance", values_from = "nn") %>% 
  mutate(rate_typeIerr = sig/iter)

bf_2group <- final_twogroups %>% 
  group_by(n, type) %>% 
  count(bf_prop) %>% 
  filter(type != "freq") %>% 
  pivot_wider(names_from = "bf_prop", values_from = "nn") %>% 
  mutate(rate_null = null/iter)

bf_3group <- final_threegroups %>% 
  group_by(n, type) %>% 
  count(bf_prop) %>% 
  filter(type != "freq") %>% 
  pivot_wider(names_from = "bf_prop", values_from = "nn") %>% 
  mutate(rate_null = null/iter)

loo_2group <- final_twogroups %>% 
  group_by(n, type) %>% 
  count(loo_results) %>% 
  filter(type != "freq") 

loo_3group <- final_threegroups %>% 
  group_by(n, type) %>% 
  count(loo_results) %>% 
  filter(type != "freq") 

waic_2group <- final_twogroups %>% 
  group_by(n, type) %>% 
  count(waic_results) %>% 
  filter(type != "freq") 

waic_3group <- final_threegroups %>% 
  group_by(n, type) %>% 
  count(waic_results) %>% 
  filter(type != "freq") 
```

#confidence intervals
```{r}
wald_2group <- wald_2group %>% rename(x = sig) 
wald2_ci <- binom.bayes(wald_2group$x, 1000, conf.level = 0.95)
wald2_ci <- wald2_ci %>% select(-n) %>% 
  inner_join(wald_2group, by = "x")

wald_3group <- wald_3group %>% rename(x = sig) 
wald3_ci <- binom.bayes(wald_3group$x, 1000, conf.level = 0.95)
wald3_ci <- wald3_ci %>% select(-n) %>% 
  inner_join(wald_2group, by = "x")

bf_2group <- bf_2group %>% rename(x = null) 
bf_2group_ci <- bf_2group %>% na.omit()
bf2_ci <- binom.bayes(bf_2group_ci$x, 1000, conf.level = 0.95)
bf2_ci <- bf2_ci %>% select(-n) %>% 
  inner_join(bf_2group, by = "x")

bf_3group <- bf_3group %>% rename(x = null) 
bf3_ci <- binom.bayes(bf_3group$x, 1000, conf.level = 0.95)
bf3_ci <- bf3_ci %>% select(-n) %>% 
  inner_join(bf_3group, by = "x")
```


#two group 
##plot by type of test
```{r}
#wald p value 
ggplot(final_twogroups, aes(x = pval)) + 
  geom_histogram(aes(y = after_stat(density)), binwidth = .05, boundary = 0) + 
  facet_grid(type ~ n)  + 
  geom_vline(xintercept = .05)

plot_finalthreegroups <- final_threegroups %>% filter(type != "freq")
ggplot(plot_finaltwogroups, aes(x = bf)) + 
  geom_histogram(aes(y = after_stat(density)), binwidth = .05, boundary = 0) + 
  facet_grid(type ~ n)  + 
  geom_vline(xintercept = 0) 

```
##plot by prior 

```{r}
ggplot(final_twogroups, aes(x = pval)) + 
  geom_histogram(aes(y = after_stat(density)), binwidth = .05, boundary = 0) + 
  facet_grid(type ~ n)  + 
  geom_vline(xintercept = .05)
```


##bf 
```{r}
#bf indicates preference for null over specified model
#bf - x1/x2 so higher --> preference for int, lower - x2
ggplot(twogroups, aes(x = bf)) + 
  geom_histogram(aes(y = after_stat(density)), binwidth = .05) + 
  facet_grid(test ~ n)  + 
  geom_vline(xintercept = .05)
```


##conf int 
```{r}
wald_2group <- wald_2group 
binom.bayes(typeIerr_2group$sig, 1000, conf.level = 0.95)

binom.confint(twogroups$pval, 1000, conf.level = 0.95, methods = "all")
```



